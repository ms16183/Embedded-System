<!--ts-->
   * [組込みシステム(Embedded System)](#組込みシステムembedded-system)
   * [組込みシステムのハードウェア構成](#組込みシステムのハードウェア構成)
   * [組込みシステム(プロセッサ)](#組込みシステムプロセッサ)
   * [組込みシステムの特性](#組込みシステムの特性)
   * [組込みシステムの利点](#組込みシステムの利点)
   * [組込みエンジニア](#組込みエンジニア)
   * [組込みスキル標準(ETSS)](#組込みスキル標準etss板書不要)
   * [スキル基準](#スキル基準板書不要)
   * [キャリア基準](#キャリア基準板書不要)
   * [組込みシステムの技術要素](#組込みシステムの技術要素)
   * [応用システムの例(スマートフォン)](#応用システムの例スマートフォン)
   * [応用システムで使用されているLSI](#応用システムで使用されているlsi)
   * [応用システムの構成](#応用システムの構成)
   * [組込みシステム用CPU](#組込みシステム用cpu)
   * [CPUの分類(RISCとCISC)](#cpuの分類riscとcisc)
   * [組込みシステム専用CPUチップの構成](#組込みシステム専用cpuチップの構成)
   * [互換性・汎用性](#互換性汎用性)
   * [CPUの技術要素](#cpuの技術要素板書不要)
   * [タイマ(時間管理機能)](#タイマ時間管理機能)
   * [省電力制御](#省電力制御)
   * [組込みソフトウェア](#組込みソフトウェア)
   * [リアルタイム性](#リアルタイム性)
   * [リアルタイム性の課題の解決](#リアルタイム性の課題の解決)
   * [リアルタイムオペレーティングシステム](#リアルタイムオペレーティングシステム)
   * [μITRON仕様RTOS](#μitron仕様rtos)
   * [組込みシステム開発](#組込みシステム開発)
   * [開発モデル](#開発モデル)
   * [コーディングアウトライン](#コーディングアウトライン)
   * [テスト技術](#テスト技術)
   * [ホワイトボックステスト](#ホワイトボックステスト)
   * [ブラックボックステスト](#ブラックボックステスト)
   * [セルフ開発環境](#セルフ開発環境)
   * [クロス開発環境](#クロス開発環境)
   * [ホストシステム](#ホストシステム)
   * [ターゲットシステム](#ターゲットシステム)
   * [デバッグ支援機器](#デバッグ支援機器)
   * [JTAGデバッガ](#jtagデバッガ)
   * [メモ](#メモ)
   * [μITRONにおけるオブジェクトの確保](#μitronにおけるオブジェクトの確保)
   * [静的生成の利点](#静的生成の利点)
   * [μITRONにおけるオブジェクトの生成](#μitronにおけるオブジェクトの生成)
   * [コンフィギュレーション](#コンフィギュレーション)
   * [オブジェクトのID番号](#オブジェクトのid番号)
   * [オブジェクトの属性](#オブジェクトの属性)
   * [オブジェクトの拡張情報](#オブジェクトの拡張情報)
   * [OSの目的](#osの目的)
   * [μITRONにおける資源の抽象化](#μitronにおける資源の抽象化)
   * [アプリケーションプログラム改装](#アプリケーションプログラム改装)
   * [カーネル階層](#カーネル階層)
   * [システムサービス(ミドルウェア)階層](#システムサービスミドルウェア階層)
   * [デバイスドライバ階層](#デバイスドライバ階層)
   * [カーネルの機能](#カーネルの機能)
   * [タスクのスケジューリング](#タスクのスケジューリング)
   * [サービスコール(API)の実行](#サービスコールapiの実行)
   * [サービスコール](#サービスコール)
   * [ASPサービスコールの動作](#aspサービスコールの動作)
   * [タスクの基本用語(mitron#51[69])](#タスクの基本用語mitron5169)

<!--te-->

# 組込みシステム(Embedded System)
- PCのような形はしていないが，機器に組み込まれるコンピュータ．
  - ハードウェアもソフトウェアも取り外すことはできない．
  - 日常，目にする電気で動作する機器はコンピュータで制御されている．
    - スイッチ，センサなどの入力が多数搭載されている．
    - CPUが演算処理を行う．
    - デジタル信号を外部の出力装置に出力したり，アクチュエータを使って物理的動作を行う．
- 専用化されたコンピュータシステム.
  - 製造個数は数個から数100万個．
  - 1つの製品に複数のCPUを使うこともある．
    - 自動車には，20から100のCPU(ECU)が使われている．
- 組込みの応用システム(アプリケーションシステム)
  - スマートフォン(携帯電話)，タブレット，自動車，炊飯器，クーラetc

# 組込みシステムのハードウェア構成
- 基本的な内部構成はPC用のハードウェア構成と変わりはない．
  - コンピュータの五大装置
    - 中央処理装置: CPU
    - 主記憶装置
    - 補助記憶装置
    - 入力装置: スイッチ，センサetc
    - 出力装置: アクチュエータ，LEDetc

  - 入出力装置: LAN，USBetc

# 組込みシステム(プロセッサ)
- 組込みシステム(プロセッサ)が広く使われる理由．
  - 汎用性があるため，組み込むプログラムにより全く異なった製品を作ることができる．
  - プログラムの変更で，設計ミスに対応できる．
    - ただし，出荷後では多額の費用がかかることがある．
  - 組込みシステムで専用回路をソフトウェア化する．
    - 専用回路と同じ動作をさせることが可能である．
    - 回路部品や機構部品の点数を大幅に削減できる．
- 専用回路で十分な機器もある．
  - 個別に開発すると時間がかかる．
  - 設計ミスがあっても変更が容易でない．

# 組込みシステムの特性
- 専用化されたシステムである．
- 低コストであることが必要である．
- 厳しいリソース制約がある．
  - メモリ容量，重量，サイズ，消費電力
- 高信頼性が要求されている．
  - システム改修に高いコストがかかる．
- リアルタイム性が要求されている．

# 組込みシステムの利点
- コスト低減化と高機能化
- 小型・高信頼性・省電力
- 保守性の向上
  - 機能の変更や追加が可能
- 設計開発期間とコストの低減
- 製造コストの低減
  - 製造工場の規模縮小化
  - 製造工程での人的スキルの低減

# 組込みエンジニア
- メーカー
  - 組込み機器メーカー
  - 組込みソフトウェアメーカー
  - 委託開発や派遣サービス

# 組込みスキル標準(ETSS)
- [ETSS(Embedded Technology Skill Standard)](https://www.ipa.go.jp/sec/softwareengineering/std/etss.html)
  - スキル基準
    - 組込みシステム開発に必要なスキルの整理と体系化
  - キャリア基準
    - 組込みシステム開発エンジニアの宿主の分売りとレベルの体系化
  - 教育研修基準
    - 組込みソフトウェアエンジニアの育成フレームワーク

# スキル基準
- 分類
  - 技術要素スキル
  - 開発技術スキル
  - 管理技術スキル
- スキルレベル
  - 1(初級)~4(最上級)

# キャリア基準
- 組込みソフトウェアエンジニアの職種
  - 10種類
- 組込みソフトウェアエンジニアの熟練度
  - レベル1~7
- 職種と熟練度の関係

# 組込みシステムの技術要素
- コンピュータ技術
- ソフトウェア技術
- 計測・制御技術
- 通信・ネットワーク技術

# 応用システムの例(スマートフォン)
- 機能
  - 音声通話機能
  - メールやWeb接続機能
  - 音楽・動画等の再生・記録機能
  - PCで使われているオフィス機能

# 応用システムで使用されているLSI
- CPU(アプリケーションプロセッサ)
  - スマートフォンではRISC型プロセッサが使われている．
- DSP(Digital Signal Processor)
  - デジタル信号処理専用のプロセッサ
    - 積和演算等を高速に処理できる．
  - 無線通信専用プロセッサ(ベースバンドプロセッサ)
    - 複数の無線システムに対応する．
- ASIC(Application Specific Intergrated Circuit)
  - 特定機能向けのLSIであり，ある機能に特化した制御を行うハードウェアも集積している．
  - MPU，メモリ，DSP等を1つのチップに集積する．
    - 小型化・コスト・性能等の高機能化が可能である．
- FPGA(Field Programmable Gate Array)
  - PLD(Programmable Logic Device)の一種で回路をプログラムで変更できる．
    - HDL(Hardware Description Language)で設計・開発を行う．
    -  HDLで記述したライブラリを利用できる．

# 応用システムの構成
- ハードウェア構成
  - アプリケーションプロセッサ(CPU)
    - RISC型プロセッサが使われている．
  - ベースバンドプロセッサ(DSP)等．
- 2つのプロセッサを並列に動作させる．
  - 機能を分散する．
  - 時間制約の厳しい処理をユーザインタフェースから分離する．
    - CPUの性能・コストを低減し，低消費電力化が期待できる．

# 組込みシステム用CPU
- 基本的な内部構成はPC用のCPUと変わりはない．
  - CPU(Central Processing Unit)の別名
    - プロセッサ(Processor)
    - マイコン(Micro Computer)
    - MPU(Micro Processing Unit)
    - ECU(Electronic control Unit)，主に自動車．

# CPUの分類(RISCとCISC)
- RISC(Reduced Instruction Set Computer)
  - 命令数を減らし(Reduced)，CPI(Clock Per Instruction)を低減する．
    - パイプライン化に適している．
  - スマートフォンではARMが主流である．
  - 省電力機能に優れている．
  - 性能向上のためマルチプロセッサ(マルチコア)技術が使われている．
- CISC(Complex Instruction Set Computer)
  - 複雑な処理(Complex)でも一つの命令でこなす．
    - CPIが増加する．
  - Intel x64，AMD64が主に使われている．
    - 複雑な命令は，複数の単純な命令に置き換えて実行する．
  - 高性能だが消費電力が大きく，冷却装置が必要である．
  - PCも低消費電力が求められているので，マルチプロセッサ(マルチコア)技術が使われている．

# 組込みシステム専用CPUチップの構成
- CPUコア
- 内蔵RAM
  - 数kバイト~数100kバイト
- 内蔵ROM
  - 一般にフラッシュメモリで交際されている．
  - 数100kバイト~数Mバイト
- 多種・多数のI/Oインターフェース
  - 省スペース
  - 省電力
- 大量に作るkとで安価にできる．
  - 組み込むプログラムにより，多様な用途に対応できる．
  - 全てのI/Oインターフェースを使う必要はない．
    - 無駄でも同じものを作った方が安価にできる．

# 互換性・汎用性
- 以前はそれほど求められなかったが，現在は強く求められるようになってきた．
  - ソフトウェアの大規模化・複雑化が進んでいる．
    - 自動車やスマートフォンでは，500万~1000万ステップのソフトウェアが搭載されている．
  - ソフトウェア開発の効率化が緊急の課題である．
- 例(スマートフォン)
  - CPUはARM
  - OSはiOSとAndroid

# CPUの技術要素
- 構成技術
  - パイプライン処理
  - マルチプロセッサ
  - スーパースカラ
- キャッシュメモリ
- 仮想記憶システム
  - MMU(Memory Management Unit)
  - 高度な組込みシステムで使用されている．
    - 組込み用 Windows, RT-Linux
- 割込み処理

# タイマ(時間管理機能)
- リアルタイム処理に不可欠な時間管理を行うためのハードウェアである．
  - 複数のレジスタで制御されるタイマが組込まれている．
    - 経過時間を測定する．
    - タイマ割り込みを発生させる．
- ウォッチドッグタイマ
  - ソフトウェアの状態を監視するタイマである．
  - 指定時間が経過すると割り込みを発生させる．
    - ソフトウェアで指定時間になる前にタイマをリセットする．

# 省電力制御
- CPU，メモリ，周辺装置などのハードウェアの省電力制御が必要である．
  - 小型化・長時間駆動・冷却簡略化の要求が強い．
- MPUの省電力機能(省電力モード)
  - スタンバイ(スリープ)
    - MPUの命令実行を停止し，割込みにより省電力モードから復帰させる．
  - サスペンド(ハイバネート，休止)
    - 動作クロックを停止して完全な停止状態にする．
    - 省電力効果は大木が，復帰までに時間がかかる．
- メモリの省電力
  - DRAMのリフレッシュを止めて消費電力を抑える．
    - セルフリフレッシュモードの仕組みを使う．
- 周辺装置(デバイス)の省電力
  - デバイス制御レジスタで省電力モードに移行する．
    - デバイスの動作状態が失われ，際初期化が必要になる場合がある．
    - デバイスドライバが省電力モードに移行する前の状態を保持し，復帰後に復元する管理が必要である．

# 組込みソフトウェア
- 組込みシステムに持ち言われているソフトウェア
  - ハードウェアに固定され，製品と一体で製品とみなされるソフトウェア．
    - PCのUEFI(Unified Extensible Firmware Interface)やBIOS(Basic Input/Output Software)も組込みソフトウェアの一種である．
- OSを使用しない場合もある．
  - メモリ容量の制約が厳しい場合．
  - 高いリアルタイム性が求められる場合．
- 昨日の一部をハードウェアで実装する．
  - 高速化・高機能化を実現できる．
    - ASIC(FPGA)により，CPUとともにiチップに実装する．
  - ハードウェアとソフトウェアの境界が曖昧になってきている．
    - C言語による論理設計も行われている．

# リアルタイム性
- 単にスループットや応答時間が短いことを言うわけではない．
- システムが定められて時間要件を満たして動作する性質であるが......
  - 制限時間内に応答を返すことを保証しない．
  - 与えられたコンピュータ資源の範囲内で最善の努力を行う．
- ハードリアルタイム
  - 定められた時間(Deadline)までに，確実に処理を完了することが求められ，完了しないと深刻な影響が生じるリアルタイム性である．
    - 車のエアバッ学では，確実に動作しないと乗員の生命に関わる．
- ソフトリアルタイム
  - 定められた時間までに処理を完了することが求められている．完了しなくても，それほど深刻な影響は生じないリアルタイム性である．
    - 車のエンジンでは，1周期ぐらいミスファイアーしても，エンジンが止まることはない．

# リアルタイム性の課題の解決
- 優先度(Priority)
  - 緊急度とも言う．
  - プログラム(タスク)の制限時間に応じて処理に優先度を持たせる．
    - 制限時間が短いタスクの優先度を高くする．
  - スケジューラ(スケジューリングアルゴリズム)に実装されている．
    - 優先度制御
    - FCFS(First Come First Saved)制御

# リアルタイムオペレーティングシステム
- リアルタイムオペレーティングシステム(RTOS)
  - リアルタイム性の保証が最重要課題のOSである．
    - リアルタイム氏が保証できなければ，他の機能を犠牲にしても良い．
- 組込みシステムのOSはリアルタイムOSが主流である．
  - OSを使用しない小規模なシステムもある．
  - WindowsやLinuxを流用することもある．
    - 欠点は，仮想記憶システムが必須であり，多くのメモリを必要とする．
- リアルタイムOSの種類
  - μITRON
  - ATK
  - OSEK/VDK
  - VxWORKS

# μITRON仕様RTOS
- 組込みシステム用リアルタイムOSとそれに関する仕様である．
  - μITRON4.0仕様が規定されている．
  - 多数の組込み用プロセッサに対応している．
  - 国内で最も広く使われている．
  - 自由に実装できるオープンな仕様である．

# 組込みシステム開発
- 汎用のシステム開発と異なり，多くの制約条件が存在する．
  - プラットフォームに起因する制約
    - 自由度が広いため，複雑なシステムはRTOSを使用するが，単純なシステムではOSを使用しない等．
  - ハードウェアに起因する制約
    - 重量，サイズ，消費電力等の制約がある．
  - 実世界との関係に起因する制約
    - 幅広い外部環境(温度・気圧等)に対応する必要がある．
- 組込みシステムの高度化・多機能化・大規模化と共に汎用システムの開発技術を適用することが必要になってきた．

# 開発モデル
- ウォータフォールモデル
  - 開発を複数の工程に分割し，各工程を完璧に仕上げ，「水が流れ落ちる」毎に次の工程へ進んでゆく手法である．
- 反復開発(スパイラル)モデル
  - 前工程への手戻りがあることを前提に，次工程からのフィードバックを考慮したモデルである．
- オブジェクト指向モデル
  - オブジェクト指向言語(C++, Java等)から発達したモデルである．
  - 記述方法としてhUML(Unified Modeling Language)が多用されている．
- プロトタイピングモデル
  - 要求定義のユーザインタフェースやアルゴリズム，動作などの検証のために，開発の初期段階で仮のシステムを作成する．
  - 各機能のユーザによる妥当性の評価を受けて機能追加，改善を行う．

# コーディングアウトライン
- プログラムの作成方法をルール化して，それに沿ったプログラミングをすることで，品質の向上につなげる手法である．
- MISRA-C
  - The Motor Industry Software Reliability Associationが策定した．
    - 車載ソフトウェアの信頼性を確保するためのC言語のコーディングガイドラインである．
    - プログラムがルールに従って作成されているか自動的にチェックするツールもある．

# テスト技術
- ウォークスルー
  - 開発関係者が集まって，意見交換を行う．
- コードインスペクション
  - レビューの一種でコードの良否を判定する．
  - 文法(ガイドライン)チェックツールなども活用する．
- ホワイトボックステスト
- ブラックボックステスト
- 結合テスト
- 性能・負荷テスト

# ホワイトボックステスト
- プログラムの処理内容に従って，意図した通りに作成されているかを確認するテストである．
- 網羅率(コードカバレッジ率)で検証の確かさを測定する．

# ブラックボックステスト
- プログラムの処理内容に着目せず，多少なデータ・状況を作り出し，入力と実行結果から設計・仕様でお降りに動作していることを確認する．
  - テストケース(条件)・テスト仕様書を作成する．
    - 設計書や要求仕様書から試験項目を策定する．
    - 試験に必要な環境・入力を記述する．
    - 予想される結果の正誤を明確に記述する．
  - テストケースに従ってテストを実施する．
    - 結果の正誤を正しく記述する．
    - 特に，誤った動作が発生する手順を克明に記述し，修正時に誤った動作を再現できるようにする．

# セルフ開発環境
- Windows用のプログラムは，Windows場で開発するのが一般的である．
  - CPUやハードウェア環境はほぼ同一である．

# クロス開発環境
- 組込みソフトウェアを開発するシステムと，組込みソフトウェアを実行するシステムが異なる環境である．
  - 組込みソフトウェアは，WindowsやUNIX等の汎用OS上で開発するのが一般的である．
    - CPUが異なっている．
    - メモリ容量が十分ではない．
    - I/O装置，外部記憶装置がない．

# ホストシステム
- ホストコンピュータ，ホストマシン等．
- 統合開発環境(IDE: Intergrated Development Environment)を使用するのが一般的である．
  - 組込みソフトウェアのコーディング・コンパイル・リンクをし，実行可能モジュールを作成する．
    - ターゲットシステムのオブジェクトコードを出力できるクロスコンパイラ，クロスアセンブラを利用する．
  - JTAG等によりターゲットシステムに接続する．
    - 実行可能モジュールをターゲットに転送し実行する．
  - TECL01/02ではCS+を使用する．

# ターゲットシステム
- ターゲットコンピュータ，ターゲットボード等．
  - ソフトウェアシミュレータを使うこともある．
- ホストシステムで作成された実行可能モジュールを実行する．

# デバッグ支援機器
- ホストシステムで作詞江下実行可能モジュールを，ターゲットシステムに転送してデバッグの支援を行うための機器である．
  - JTAG(Joint Eurpean Test Action Group)
  - ICE(In-Circuit Emulator)
    - CPUのソケットに接続し，ターゲットのCPUと同じ動作を行う．
  - ROMエミュレータ
    - ROMソケットに接続し，モニタプログラムによりデバッグを行う．

# JTAGデバッガ
- 組込みシステムのデバッグを行うためのシリアル通信の規格である．
  - 組込みシステムに使用される多くのCPUにJTAGエミュレータ機能が組み込まれている．
  - 命令の停止・ステップ実行や，レジスタ・メモリの内容を表示・変更するデバッグ機能がある．
  - JTAG-ICE(JTAGデバッガ)
    - ICEとほぼ同じデバッグ機能を利用できる．
    - TECL01/02/では，E1/E2エミュレータを使用する．

# メモ
- RTOSでは必要なメモリ領域はあらかじめ確保する．
- 汎用OSは一般的に実行時に割り当てる．

# μITRONにおけるオブジェクトの確保
- 必要となるオブジェクトはあらかじめ確保する．
  - 政敵生成と呼ぶ．
  - 組込みシステムでは，電源がONになった浴後に，カーネルが起動し，有限の数のタスクが動作するが新しい機能の追加はない．
    - 起動時に資源が確保されていればその後に資源の生成や削除は不要である．

# 静的生成の利点
- 製品を作る前に，必要なメモリ容量を決定できる．
  - 資源が枯渇することはない．
  - 内臓RAMに合わせてオブジェクトを割り当てる．
    - 必要なオブジェクトが，内臓RAMに収まるようにプログラムを作る．
- 生成時間は0であり，リアルタイム生が確保できる．
- オブジェクト生成時の初期化情報を動的に変更することはないので，初期化情報を比較的余裕のある内蔵ROMに置くことができる．

# μITRONにおけるオブジェクトの生成
- オブジェクトは基本的に静的に生成される．
  - オブジェクトは静的APIにより定義し，メモリ領域が割り当てられる(#page=74, 92ページ)
- オブジェクトを定義する静的APIはシステム・コンフィギュレーション・ファイルに記述する．
  - C言語のアプリケーションプログラムを記述するファイルとは別になっている．
  - ASPでは，`<APPLNAME>.cfg`である．
- コンフィギュレータにより，C言語のプログラムのファイルに変換する．
  - ASPでは，`kernel_cfg.c`と`kernel_cfg.h`である．

# コンフィギュレーション
- 組込みソフトウェアで使用するリソースは，静的にリンクする．
  - リソース用のメモリ領域をコンパイル時に決定する．
    - 必要なメモリ容量を決定することができる．
- リソースはシステムコンフィギュレーションファイル(`<APPLNAME>.cfg`)に記述する．
- コンフィギュレータ(`cfg/cfg.exe`)により処理する．

# オブジェクトのID番号
- アプリケーションプログラムが自由に番号を割りつけることができる場合は，ID番号と呼ぶ．
  - ID番号にはマクロ名(大文字，数字，`_`)をつけるが，コンフィギュレータにより，種類毎にユニークな番号が割り振られる．

# オブジェクトの属性
- ID番号で識別されるオブジェクトは，オブジェクト属性を持つ(mitro#30[48])．
  - オブジェクトの詳細な動作や初期状態を定める．
  - オブジェクトの種類別に指定できる属性は異なっている．

# オブジェクトの拡張情報
  - 実行実態となるオブジェクト(タスク等)は，拡張情報を持つ場合がある(mitron#30[48])．
    - 拡張情報にオブジェクトの登録時(静的API等)に指定し，オブジェクトが実行を始めるときにパラメータとして渡される．
      - `CRE_TSK「タスクの生成(静的API)」の拡張情報exinfは，タスク関数のパラメータとして渡される．

# OSの目的
- ハードウェア・リソース(資源)の抽象化
- 資源の管理
  - 有限個しかない資源を，複数のタスク(仕事)が取り合ったりしないように管理する．
- 資源の使用効率の向上
  - 複数のタスクに最適に割り当てる．
- 資源のアクセス保護
  - 他のタスクからの誤ったアクセスを排除する．

# μITRONにおける資源の抽象化
- μITRONにおける資源の抽象化とは，CPUコア(プロセッサ)に限定した，ゆるい抽象化である．
  - CPUコアのデバイスドライバである．
  - 幅広いCPUコアを対象としている．
  - アプリケーションプログラムからは，統一されたサービスコールでカーネルにアクセスする．
- CPUコア以外の周辺デバイスは，μITRON仕様のOSの管理外である．
  - 周辺デバイスは，デバイスドライバ・ガイドライン等の外部仕様を用意している．

# アプリケーションプログラム改装
- ユーザが作成するタスクの集まりである．

# カーネル階層
- ハードウェア非依存部
  - フォルダ`kernel`, `include`内にハードウェアに依存しないカーネル機能を実装している．
    - 例えば，スケジューリングアルゴリズムの実装はハードウェアに依存しないため，`kernel/task.c`に集約されているが，ディスパッチ機能はない．
- ハードウェア依存部
  - フォルダ`arch`，`target`以下のフォルダ内には，ハードウェアに依存するカーネル機能を実装している．
    - 例えば，ディスパッチ機能はハードウェアに依存し，アセンブリ言語で記述されている．TECL01/02では，`arch/rx620_ccrx/prx_support.srcにディスパッチ機能，割り込み・CPU例外ハンドラの入出力処理等が集約されている．

# システムサービス(ミドルウェア)階層
- アプリケーションプログラムから呼び出されるカーネルのサービスコールと同様の呼び出し形式で，付加的な機能を実現する．
  - μITRONでは，ソフトウェア部品とも呼ばれている．
  - デバイスドライバ設計ガイドラインではGDIC(General Device Interface Component)とも呼ばれている．

# デバイスドライバ階層
- ASPは3階層で構成されている．
  - デバイスドライバインターフェース階層
  - ハードウェア依存階層(PDIC(Primtivice Device Interface component)階層)
  - SIL(System Interface Layer)階層
- デバイスドライバインターフェース階層
  - カーネル・システムサービスから呼び出されるデバイスドライバインターフェースである．
    - プロセッサ依存部[arch]
    - システム(ボード依存部)[target]
  - PDIC階層を経由してデバイスを制御する．
- ハードウェア依存階層(PDIC階層)
  - SIL階層を経由してデバイス(入出力レジスタ等)を制御する．
- SIL(System Interface Layer)階層
  - ハードウェアの違いを吸収する．
    - 割り込みロック制御
    - 微小時間待ち
    - バイトオーダ

# カーネルの機能
- リアルタイム処理
  - 予測できないタイミング(非同期)に発生するイベントに対して，リアルタイムに(時間要件を満たして)対応するタスクを実行する．
  - フォルダにはSIL階層の定義も含んでいる．

# タスクのスケジューリング
- 複数のタスクから，実行順位を決めてタスクを実行する．

# サービスコール(API)の実行
  - タスクの実行に必要なOSの機能を実現する．

# サービスコール
- アプリケーションプログラムや割り込み処理プログラムから，カーネルまたはシステムサービス(ソフトウェア部品)を呼び出すインターフェースである．
- μITRON仕様(mitron#24[42])
  - 名称，機能，パラメータとリターンパラメータの種類・順序・名称・データ型が標準化されている．

# ASPサービスコールの動作
- サービスコールの呼び出しでは，基本的にディスパッチが発生することがある．
  - 自タスクより優先度の高いタスクがあれば，自タスクは，プリ園とされ「実行可能状態」に遷移する．
- ディスパッチが発生しないサービスコールもある．
- タスク管理(同期・例外処理)
- 同期・通信機能
- メモリ管理機能
- 時間管理機能
- システム状態・公正管理機能
- 割り込み・例外処理管理機能
- 拡張サービスコール管理機能

# タスクの基本用語(mitron#51[69])
- タスク
  - プログラムの並列実行単位である．
  - 一つのタスク中のプログラムは逐次的に実行される．
  - 異なるタスクのプログラムは並行して実行される．
    - アプリケーションプログラムから見た動作である．
    - スケジューリングアルゴリズムに従って実行される．
- 自タスク
  - サービスコールを呼び出したタスクである．
- ディスパッチ
  - プロセッサが実行するタスクを切り替えることである．
    - タスクを「実行可能状態」から「実行状態」に遷移させる．
- プリエンプト
  - 実行中のタスクから強制的にプロセッサを奪い取ることである．

- スケジューリング
  - 次に実行すべき(実行可能状態から実行状態に遷移させる)タスクを決定する処理である．
  - スケジューリングを行うカーネル内の機能を「スケジューラ」と呼ぶ．
  - スケジューラは，サービスコール処理内やディスパッチ内に実装されている．
    - タスクを「実行可能状態」に遷移させることである．
- コンテキスト
  - プログラム(タスク)が実行される環境であり，プロセッサのどうsモード，レジスタ，スタック区kなんから構成されている．
    - アプリケーションプログラムから見た実行環境である．
    - ディスパッチャにより，実行されるコンテキストが切り替えられるが，アプリケーションプログラムからは見えない．
  - ASPでは，コンテキストはタスク管理ブロック(TCB: Task Control Block)に保持されている(kernel/task.h#212)．
- 優先順位
  - タスクを実行する順序を決める順序関係である．
  - 原則として，優先順位の低いタスクが「実行状態」出会っても，優先順位が高いタスクが「実行可能状態」になった場合は，
    - 優先順位の低いタスクは「実行可能状態」に遷移する(プリエンプト)
    - 優先順位の高いタスクが「実行状態」に遷移する(ディスパッチ)．

# タスクの状態(mitron#52[70])
- [1]実行状態(RUNNING)
  - 現在そのタスクが実行中であるという状態である．
- [2]実行可能状態(READY)
  - そのタスクよりも優先順位が高いタスクが実行中のため，そのタスクを実行できない状態である．
    - 事項できる状態のタスクの中で最高の優先順位になれば，いつでも実行できる状態である．
- 広義の待ち状態
  - そのタスクを実行できる条件が揃わないために実行できない状態である．
  - μITRON仕様では，さらに3つの状態([3], [4],[5])に分類されている．
- [3]待ち状態(WAITING)
  - 字タスクの実行を中断するサービスコールを呼び出したことにより，実行が中断された状態である．
- [4]二重待ち状態(WAITING-SUSPENDED)
  - 「待ち状態」と「強制待ち状態」が重なった状態である．
- [5]強制待ち状態(SUSPENDED)
  - 他のタスクにより強制的に実行を中断させられた状態である．
  - 自タスクを強制的に待ち状態にすることもできる．
- [6]休止状態(DORMANT)
  - タスクがまだ起動されていないか，実行を終了した後の状態である．
- [7]未登録状態(NON-EXISTENT)
  - タスクがまだ生成されていないか(cre_tsk)，削除された後(del_tsk)，登録されていない仮想的な状態である．

# ITRON タスクスケジューリング
- リアルタイム性の観点から，実行状態が予測できることが重要である．
- 優先度ベーススケジューリングである．
  - 優先度の高いタスクを実行状態にする．
    - 優先度の高いタスクが実行できる状態にあると，低い優先度のタスクは全く実行されない．
    - プリエンプト可能(強制的な実行可能状態への移行)である．
  - ROPPERS/ASP・JSPでは，優先度は1~16で，低い値ほど優先度は高い．
- FCFS(First Come First Served)方式
  - 同一優先度の場合は，先に実行可能包帯になったタスクを実行状態にする．
     - 同一のタスクが実行し続ける．

# レディキュー(ready queue)
- スケジューリング規則を実現するための優先度を表す配列である．
  - 待ち行列を実現する双方向リストのルートノードからなる配列であり，優先度順に並んでいる．

# スケジューラの実装
- 優先度ベーススケジューリング
  - レディキューの要素\[0\](高優先度1)から順に\[15\](程優先度16)に向かってTCBがリンクされている最初のルートノードを探索する．
    - 見つかった要素の最初にリンクされているTCBが，「実行状態」に遷移させる最高順位のタスクのTCBである．
- FCFS方式
  - タスクが「実行可能状態」に遷移すると，そのタスクが持つ優先度のレディキューの要素にリンクされる．
    - レディキューの要素にリンクしている「最初のTCB」が「実行状態」に遷移される「最初に来た」タスクのTCBである．

# 同期・通信オブジェクト(WOBJ)
- タスク間で同期・通信を行うオブジェクト(待ちオブジェクト)
  - セマフォ
  - イベントフラグ
  - データキュー
  - メールボックス

# セマフォ
- 相互排除問題の解である．
  - オランダ語で腕木信号機を意味している．
- 共有資源の強豪の解決の手順
  - 共有資源が使用可能になるまで待つ(操作P)．
  - 臨界領域を解放する(操作V)．
` ITRONは係数セマフォである．

